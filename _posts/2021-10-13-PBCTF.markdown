---
layout: post
title: PBCTF 2021
date: 2021-10-13 00:00:00 +0300
description: WU Crypto # Add post description (optional)
img: PBCTF-panel.png # Add image post (optional)
tags: [Crypto, CTF] # add tag
---

# **PBCTF 2021**

# **ALKALOID STREAM** (134 pts)
*I found a weird stream cipher scheme. Can you break this?*

gen.py
```
#!/usr/bin/env python3

import random
from flag import flag

def keygen(ln):
    # Generate a linearly independent key
    arr = [ 1 << i for i in range(ln) ]

    for i in range(ln):
        for j in range(i):
            if random.getrandbits(1):
                arr[j] ^= arr[i]
    for i in range(ln):
        for j in range(i):
            if random.getrandbits(1):
                arr[ln - 1 - j] ^= arr[ln - 1 - i]

    return arr

def gen_keystream(key):
    ln = len(key)
    
    # Generate some fake values based on the given key...
    fake = [0] * ln
    for i in range(ln):
        for j in range(ln // 3):
            if i + j + 1 >= ln:
                break
            fake[i] ^= key[i + j + 1]

    # Generate the keystream
    res = []
    for i in range(ln):
        t = random.getrandbits(1)
        if t:
            res.append((t, [fake[i], key[i]]))
        else:
            res.append((t, [key[i], fake[i]]))

    # Shuffle!
    random.shuffle(res)

    keystream = [v[0] for v in res]
    public = [v[1] for v in res]
    return keystream, public

def xor(a, b):
    return [x ^ y for x, y in zip(a, b)]

def recover_keystream(key, public):
    st = set(key)
    keystream = []
    for v0, v1 in public:
        if v0 in st:
            keystream.append(0)
        elif v1 in st:
            keystream.append(1)
        else:
            assert False, "Failed to recover the keystream"
    return keystream

def bytes_to_bits(inp):
    res = []
    for v in inp:
        res.extend(list(map(int, format(v, '08b'))))
    return res

def bits_to_bytes(inp):
    res = []
    for i in range(0, len(inp), 8):
        res.append(int(''.join(map(str, inp[i:i+8])), 2))
    return bytes(res)

flag = bytes_to_bits(flag)

key = keygen(len(flag))
keystream, public = gen_keystream(key)
assert keystream == recover_keystream(key, public)
enc = bits_to_bytes(xor(flag, keystream))

print(enc.hex())
print(public)

```

output.txt
```
file nÃ y sáº½ up trÃªn drive nha, file nÃ y lá»›n! Link sáº½ Ãºp-Ä‘Ã©t sau
https://drive.google.com/file/d/1QuEBKTnVjQ_5XEpWemO5GMJVT_qwbhTb/view?usp=sharing

Ä‘Ã¢y nÃ¨ :D
```

**Solve:**

Nháº­n xÃ©t:

Ban Ä‘áº§u mÃ¬nh Ä‘Æ°a biáº¿n enc á»Ÿ file txt vá» dáº¡ng bits, thÃ¬ tháº¥y nÃ³ dÃ i 600bits

BÃ i nÃ y khÃ¡ khoai náº¿u chá»‰ nhÃ¬n chÄƒm chÄƒm vÃ o cÃ¡ch nÃ³ encrypt mÃ  khÃ´ng chÃº Ã½ kÄ© vÃ o tá»«ng hÃ m, Ä‘áº·c biá»‡t lÃ  hÃ m gen_keystream cá»§a nÃ³. Cá»¥ thá»ƒ nhÆ° sau:
```
for i in range(ln):
        for j in range(ln // 3):
            if i + j + 1 >= ln:
                break
            fake[i] ^= key[i + j + 1]
```

- Dá»«ng khoáº£ng chá»«ng lÃ  2 giÃ¢y? VÃ¬ i cháº¡y tá»« 0 Ä‘áº¿n ln-1, váº­y náº¿u i == ln-1 thÃ¬ pháº§n if sáº½ thá»a mÃ£n Ä‘iá»u kiá»‡n vÃ  break ngay, Ä‘á»“ng nghÄ©a vá»›i viá»‡c fake[ln-1] = 0
- Láº§n theo dáº¥u váº¿t Ä‘Ã³ thÃ¬ fake[ln-2] sáº½ báº±ng key[ln-1], fake[ln-3] = key[ln-1] ^ key[ln-2] = fake[ln-2] ^ key[ln-2]
- Váº­y cÃ´ng thá»©c tá»•ng quÃ¡t 200 pháº§n tá»­ Ä‘áº§u mÃ¬nh Ä‘Ã£ cÃ³! MÃ¬nh chá»‰ cáº§n xor fake vÃ  key cá»§a i-1 rá»“i xem á»Ÿ dÃ²ng i xuáº¥t hiá»‡n á»Ÿ bÃªn nÃ o(Do vÃ²ng j for Ä‘áº¿n 600/3 = 200)
- Váº­y 400 pháº§n tá»­ cÃ²n láº¡i mÃ¬nh tÃ¬m nhÆ° nÃ o? Sau khi nháº­n xÃ©t Ä‘Æ°á»£c key vÃ  fake á»Ÿ má»—i lÆ°á»£t tÃ¬m kiáº¿m, mÃ¬nh lÆ°u 200 pháº§n tá»­ trÆ°á»›c Ä‘Ã³ vÃ o 1 máº£ng luÃ´n, sau Ä‘Ã³ cá»© má»—i láº§n tÃ¬m Ä‘Æ°á»£c key, mÃ¬nh Ä‘á»u lÆ°u láº¡i Ä‘á»ƒ sá»­ dá»¥ng cho viá»‡c phÃ¢n biá»‡t key vÃ  fake tiáº¿p theo.

- VÃ  Ä‘Ã¢y lÃ  code tÃ¬m 200 cÃ¡i key Ä‘áº§u cá»§a mÃ¬nh, vá» pháº§n key[599], ta dá»… dÃ ng tÃ¬m Ä‘Æ°á»£c vÃ¬ fake[599] = 0

```
step = 205
check[step] = True
cou = 1
step = 1400714221870952494615363674397671002942566332491236206763593417473795738355401350930926673064015705912976960035864926610332139062931171063676126565794843044414821051808290441350503
realkey = [0]*600
realkey[599] = step
suffix = step 

while (True):
    fstep = step
    for i, u in enumerate(public):
        if (check[i] == False):
            v0, v1 = u[0], u[1]
            if (v0 == step):
                cou+=1
                check[i] = True
                keystream[i] = 1
                realkey[600 - cou] = v1
                suffix ^= v1
                step = v0^v1
                break
            elif (v1 == step):
                cou+=1
                check[i] = True
                keystream[i] = 0
                realkey[600 - cou] = v0
                suffix ^= v0
                step = v0^v1
                break

    if (cou == 200):
        break
```

- Tiáº¿p theo do Ä‘Ã£ cÃ³ 200 key Ä‘áº§u, mÃ¬nh tÃ¬m cÃ¡c key sau: Cá»© má»—i lÆ°á»£t, mÃ¬nh xor thÃªm tháº±ng káº¿ tiáº¿p vÃ  bá» Ä‘i tháº±ng thá»© 201 ká»ƒ tá»« vá»‹ trÃ­ Ä‘ang xÃ©t cá»§a mÃ¬nh, Ä‘á»ƒ thá»a mÃ£n viá»‡c tá»« vá»‹ trÃ­ i, fake = 200 key liÃªn tiáº¿p xor nhau:

```
while (True):
    for i, u in enumerate(public):
        if (check[i] == False):
            v0, v1 = u[0], u[1]
            if (v0 == suffix):
                cou+=1
                check[i] = True
                keystream[i] = 1
                realkey[600 - cou] = v1
                suffix ^= v1
                suffix ^= realkey[800 - cou]
                break
            elif (v1 == suffix):
                cou+=1
                check[i] = True
                keystream[i] = 0
                realkey[600 - cou] = v0
                suffix ^= v0
                suffix ^= realkey[800 - cou]
                break
    if (cou == 600):
        break
```

Ã” kÃª la váº­y lÃ  xong rá»“i, viá»‡c cÃ²n láº¡i lÃ  in flag thÃ´i, mÃ¬nh mÆ°á»£n cÃ¡i hÃ m bytes_to_bit vÃ  bits_to_bytes tá»« Ä‘á» bÃ i luÃ´n ðŸ˜Ž
```
def bytes_to_bits(inp):
    res = []
    for v in inp:
        res.extend(list(map(int, format(v, '08b'))))
    return res

def bits_to_bytes(inp):
    res = []
    for i in range(0, len(inp), 8):
        res.append(int(''.join(map(str, inp[i:i+8])), 2))
    return bytes(res)

def xor(a, b):
    return [x ^ y for x, y in zip(a, b)]

enc = "cd4c1a7edd7a421dcea72ae8bf47946d74f6cdba763a6a052a3f2955333dc6fa267f5297c405bf807e922380ebf9628194bf319e8ae4074dc5476de1d81a52d72c29f0e8b590ac8f6a78bb"
public = [copy tá»« file ra áº¥y, táº¡i tui lÆ°á»i import ðŸ™„]
import random

enc = bytes_to_bits(bytes.fromhex(enc))
print("len bits enc = ", len(enc))

print("len pub = ", len(public))
keystream = [0]*601
check = [False]*601

step = 205
check[step] = True
cou = 1
step = 1400714221870952494615363674397671002942566332491236206763593417473795738355401350930926673064015705912976960035864926610332139062931171063676126565794843044414821051808290441350503
realkey = [0]*600
realkey[599] = step
suffix = step 

while (True):
    fstep = step
    for i, u in enumerate(public):
        if (check[i] == False):
            v0, v1 = u[0], u[1]
            if (v0 == step):
                cou+=1
                check[i] = True
                keystream[i] = 1
                realkey[600 - cou] = v1
                suffix ^= v1
                step = v0^v1
                break
            elif (v1 == step):
                cou+=1
                check[i] = True
                keystream[i] = 0
                realkey[600 - cou] = v0
                suffix ^= v0
                step = v0^v1
                break

    if (cou == 200):
        break

while (True):
    for i, u in enumerate(public):
        if (check[i] == False):
            v0, v1 = u[0], u[1]
            if (v0 == suffix):
                cou+=1
                check[i] = True
                keystream[i] = 1
                realkey[600 - cou] = v1
                suffix ^= v1
                suffix ^= realkey[800 - cou]
                break
            elif (v1 == suffix):
                cou+=1
                check[i] = True
                keystream[i] = 0
                realkey[600 - cou] = v0
                suffix ^= v0
                suffix ^= realkey[800 - cou]
                break
    if (cou == 600):
        break

print(bits_to_bytes(xor(enc, keystream)))
```

>FLAG: pbctf{super_duper_easy_brute_forcing_actually_this_one_was_made_by_mistake}